rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funções Auxiliares v2.0 ---

    // Verdadeiro se o usuário logado for Admin ou Curador, baseado nos Custom Claims do token.
    function isAdminOrCurator() {
      return request.auth.token.role == 'admin' || request.auth.token.role == 'curador';
    }

    // Verdadeiro se o ID do usuário logado corresponde ao 'creatorUid' do documento que está sendo acessado.
    function isOwnerOfDoc() {
      // `resource` é o documento como ele existe no banco de dados.
      return request.auth.uid == resource.data.creatorUid;
    }

    // --- Regras das Coleções ---

    // Coleção 'users': Armazena dados de admins e criadores
    match /users/{userId} {
      // Qualquer usuário autenticado pode ler seu próprio perfil de usuário.
      // Admins/Curadores podem ler o perfil de qualquer um.
      allow read: if request.auth.uid == userId || isAdminOrCurator();

      // Ninguém pode atualizar ou deletar perfis de usuário diretamente via cliente
      // para garantir a integridade dos dados. Essas operações devem ser feitas via backend com privilégios de admin.
      allow write: if false;
    }

    // Coleção 'submissions': Armazena os projetos enviados
    match /submissions/{submissionId} {
      // Admins e Curadores têm acesso total de leitura e escrita.
      allow read, write: if isAdminOrCurator();
      
      // Um Criador pode ler e atualizar seus próprios documentos de submissão.
      // Isso é essencial para o novo dashboard (ex: confirmar presença em reunião).
      allow read, update: if isOwnerOfDoc();

      // Ninguém pode criar ou deletar submissões diretamente via cliente.
      // A criação é feita via API (com SDK Admin) e o delete é uma operação restrita de admin.
      allow create, delete: if false;
    }
  }
}
